<launch>

    <!-- 左カメラからのトピック名 -->
    <arg name="left_image_rect_raw" default="/infra_cam/left/infra1/image_rect_raw" />
    <arg name="left_image_diff" default="/infra_cam/left/image_diff" />
    <arg name="left_image_diff_bivaluation" default="/infra_cam/left/image_diff_bivaluation" />
    <arg name="left_cog" default="/infra_cam/left_cog" />

    <!-- 右カメラからのトピック名 -->
    <arg name="right_image_rect_raw" default="/infra_cam/right/infra2/image_rect_raw" />
    <arg name="right_image_diff" default="/infra_cam/right/image_diff" />
    <arg name="right_image_diff_bivaluation" default="/infra_cam/right/image_diff_bivaluation" />
    <arg name="right_cog" default="/infra_cam/right_cog" />


    <!-- カメラからの情報を処理して得たトピック名 -->
    <arg name="depth" default="/infra_cam/depth" />
    <arg name="position" default="/infra_cam/position" />
    <arg name="position_stamped" default="/infra_cam/position_stamped" />

    <!-- マイコンからの情報のトピック名 -->
    <arg name="imu_tof" default="/imu_tof" />
    <arg name="input_propo_topic_name" default="/controller" />

    <!-- マイコンからの情報を処理して得たトピック名 -->
    <arg name="altitude" default="altitude" />
    <arg name="quat" default="quat" />
    <arg name="propo" default="command" />
    <arg name="propo_explicit" default="propo_explicit" />
    <arg name="mode" default="mode" />

    <!-- 機体角の制御用のトピック名 -->
    <arg name="rpy_angular" default="/rpy_angular" />
    <arg name="rpy_angular_speed" default="/rpy_angular_speed" />

    <!-- カメラのパラメータファイルのパス -->
    <arg name="camera_param_left"
        default="$(find-pkg-share nokolat2024)/param/camera_param_left.yaml" />
    <arg name="camera_param_right"
        default="$(find-pkg-share nokolat2024)/param/camera_param_right.yaml" />

    <group>

        <push_ros_namespace namespace="infra_cam" />

        <group>
            <push-ros-namespace namespace="left" />
            <node pkg="nokolat2024" exec="image_diff_extraction" name="image_diff_extraction"
                output="screen">
                <param name="input_ir_image_topic_name" value="$(var left_image_rect_raw)" />
                <param name="output_image_topic_name" value="$(var left_image_diff)" />
            </node>
        </group>

        <group>
            <push-ros-namespace namespace="right" />
            <node pkg="nokolat2024" exec="image_diff_extraction" name="image_diff_extraction"
                output="screen">
                <param name="input_ir_image_topic_name" value="$(var right_image_rect_raw)" />
                <param name="output_image_topic_name" value="$(var right_image_diff)" />
            </node>
        </group>

        <node pkg="nokolat2024" exec="cog_corrected" name="cog_corrected" output="screen">
            <param name="input_left_image_topic_name" value="$(var left_image_diff)" />
            <param name="input_right_image_topic_name" value="$(var right_image_diff)" />
            <param name="output_left_cog_topic_name" value="$(var left_cog)" />
            <param name="output_right_cog_topic_name" value="$(var right_cog)" />
            <param name="yaml_left_file" value="$(var camera_param_left)" />
            <param name="yaml_right_file" value="$(var camera_param_right)" />
        </node>
        <node pkg="nokolat2024" exec="depth_estimation" name="depth_estimation" output="screen">
            <param name="input_left_cog_topic_name" value="$(var left_cog)" />
            <param name="input_right_cog_topic_name" value="$(var right_cog)" />
            <param name="output_depth_topic_name" value="$(var depth)" />
            <param name="yaml_right_file" value="$(var camera_param_right)" />
        </node>
        <node pkg="nokolat2024" exec="position_estimation" name="position_estimation"
            output="screen">
            <param name="input_left_cog_topic_name" value="$(var left_cog)" />
            <param name="input_right_cog_topic_name" value="$(var right_cog)" />
            <param name="input_depth_topic_name" value="$(var depth)" />
            <param name="output_position_topic_name" value="$(var position)" />
            <param name="yaml_right_file" value="$(var camera_param_right)" />
        </node>

        <node pkg="nokolat2024" exec="point2pointStamped" name="point2pointStamped" output="screen">
            <param name="input_position_topic_name" value="$(var position)" />
            <param name="output_stamped_topic_name" value="$(var position_stamped)" />
        </node>


    </group>

    <group>

        <push_ros_namespace namespace="onboard" />

        <node pkg="nokolat2024" exec="imu_tof2posAndQuat" name="imu_tof2posAndQuat" output="screen">
            <param name="input_imu_tof_topic_name" value="$(var imu_tof)" />
            <param name="output_altitude_stamped_topic_name" value="$(var altitude)" />
            <param name="output_quaternion_topic_name" value="$(var quat)" />
        </node>

        <node pkg="nokolat2024" exec="tf_publisher" name="tf_publisher" output="screen">
            <param name="input_position_topic_name" value="$(var position_stamped)" />
            <param name="input_altitude_stamped_topic_name" value="$(var altitude)" />
            <param name="input_quaternion_topic_name" value="$(var quat)" />
        </node>

        <node pkg="nokolat2024" exec="projection_xy" name="projection_xy" output="screen" />

        <node pkg="nokolat2024" exec="recive_command" name="recive_command" output="screen">
            <param name="input_propo_topic_name" value="$(var propo)" />
            <param name="output_command_explicit_topic_name" value="$(var propo_explicit)" />
            <param name="output_mode_topic_name" value="$(var mode)" />

        </node>

        <node pkg="nokolat2024" exec="tf2rpy" name="tf2rpy" output="screen">
            <param name="output_angular_topic_name" value="$(var rpy_angular)" />
            <param name="output_angular_velocity_topic_name" value="$(var rpy_angular_speed)" />
        </node>

        <node pkg="tf2_ros" exec="static_transform_publisher" name="map_to_camera"
            output="screen" args="0 0 1 0 0.2164396 0 0.976296 map camera_link" />

        <node pkg="tf2_ros" exec="static_transform_publisher" name="camera_to_left"
            output="screen" args="0.065 0 0 0 0 0 1 camera_link left_camera_link" />

        <node pkg="tf2_ros" exec="static_transform_publisher" name="base_link_to_imu_link"
            output="screen" args="0.065 0 0 0 0 0 1 base_link imu_link" />

        <node pkg="micro_ros_agent" exec="micro_ros_agent" name="micro_ros_agent" output="screen"
            args="udp4 --port 8888" />

    </group>

    <node pkg="rviz2" exec="rviz2" name="rviz"
        args="-d $(find-pkg-share nokolat2024)/rviz/rvizmodel.rviz" output="screen" />


</launch>